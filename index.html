<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航班資料分析工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 所有CSS樣式保持不變 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 30px;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px dashed #bdc3c7;
            text-align: center;
        }
        
        .upload-btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
            margin: 10px;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .file-name {
            margin-top: 15px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .instructions {
            background-color: #fff9e6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #f39c12;
        }
        
        .instructions h3 {
            color: #d35400;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .person-selector {
            background-color: #eaf2f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: none;
        }
        
        .person-selector label {
            font-weight: bold;
            margin-right: 10px;
            color: #2c3e50;
        }
        
        .person-selector select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            font-size: 16px;
            min-width: 200px;
            background-color: white;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .summary-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 4px solid #3498db;
        }
        
        .summary-item h3 {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-item p {
            font-size: 28px;
            font-weight: bold;
            color: #2980b9;
        }
        
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: none;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .chart-header h3 {
            color: #2c3e50;
        }
        
        .person-name-display {
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .person-total-flights {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .chart-wrapper {
            height: 400px;
            position: relative;
        }
        
        .month-total {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .status.error {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status.info {
            background-color: #d6eaf8;
            color: #3498db;
            border: 1px solid #3498db;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
            display: none;
        }
        
        .action-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
            min-width: 150px;
        }
        
        .action-btn:hover {
            background-color: #27ae60;
        }
        
        .action-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .download-btn {
            background-color: #9b59b6;
        }
        
        .download-btn:hover {
            background-color: #8e44ad;
        }
        
        .person-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            display: none;
        }
        
        @media (max-width: 1000px) {
            .person-details {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .detail-header {
            background-color: #34495e;
            color: white;
            padding: 15px;
            border-radius: 6px 6px 0 0;
            font-size: 18px;
            font-weight: bold;
            margin: -20px -20px 20px -20px;
        }
        
        .auth-header {
            background-color: #2c3e50;
        }
        
        .non-auth-header {
            background-color: #7f8c8d;
        }
        
        .detail-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .flight-item {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            margin-bottom: 10px;
        }
        
        .flight-date {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .flight-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .flight-count {
            display: inline-block;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
            font-style: italic;
        }
        
        .person-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .person-info-item {
            text-align: center;
            flex: 1;
        }
        
        .person-info-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .person-info-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .person-info-value.auth {
            color: #27ae60;
        }
        
        .person-info-value.non-auth {
            color: #e74c3c;
        }
        
        .name-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .name-tag {
            background-color: #eaf2f8;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }
        
        .name-tag.auth {
            background-color: #d5f4e6;
            border-color: #27ae60;
        }
        
        .name-tag.non-auth {
            background-color: #fadbd8;
            border-color: #e74c3c;
        }
        
        .variant-names {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .variant-names span {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .file-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .debug-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #e74c3c;
        }
        
        .debug-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px dashed #ddd;
        }
        
        .found-names-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .found-names-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>航班資料分析工具</h1>
            <p class="subtitle">上傳Excel檔案，自動分析航班資料並生成統計圖表</p>
        </header>
        
        <div class="instructions">
            <h3>使用說明</h3>
            <ul>
                <li>上傳Excel檔案（格式需與高雄機務組每日班機動態表相同）</li>
                <li>系統將自動分析航班資料，區分授權人員（簽放人員）和非授權人員（接機/協助人員）</li>
                <li>使用下拉式選單選擇人員，查看該人員當月的航班統計圖表</li>
                <li>系統會自動拆分多人欄位，正確識別每個人名</li>
                <li>系統會自動過濾非人名詞彙（如：簽、班、加、上、拖、車輛等工作備註）</li>
                <li>最後可下載包含所有人員航班資料的單一CSV檔案</li>
            </ul>
        </div>
        
        <div class="upload-section">
            <h3>請選擇要上傳的Excel檔案</h3>
            <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
                選擇檔案
            </div>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileSelect(event)">
            <div id="fileName" class="file-name"></div>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>正在分析檔案，請稍候...</p>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="person-selector" id="personSelector">
            <label for="personSelect">選擇人員：</label>
            <select id="personSelect" onchange="selectPerson(this.value)">
                <option value="">請選擇人員</option>
                <!-- 人員選項將動態生成 -->
            </select>
        </div>
        
        <div class="summary" id="summary">
            <!-- 摘要內容將動態生成 -->
        </div>
        
        <div class="chart-container" id="chartContainer">
            <div class="chart-header">
                <h3>航班統計圖表</h3>
                <div>
                    <span>人員：</span>
                    <span class="person-name-display" id="personNameDisplay"></span>
                    <span style="margin-left: 20px;">總航班數：</span>
                    <span class="person-total-flights" id="personTotalFlights"></span>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="flightChart"></canvas>
            </div>
        </div>
        
        <div class="person-details" id="personDetails">
            <div class="detail-box">
                <div class="detail-header auth-header">
                    授權航班資料
                </div>
                <div class="detail-content" id="authDetails">
                    <!-- 授權航班資料將動態生成 -->
                </div>
            </div>
            
            <div class="detail-box">
                <div class="detail-header non-auth-header">
                    非授權航班資料
                </div>
                <div class="detail-content" id="nonAuthDetails">
                    <!-- 非授權航班資料將動態生成 -->
                </div>
            </div>
        </div>
        
        <div class="month-total" id="monthTotal">
            <!-- 當月總航班數將動態生成 -->
        </div>
        
        <div class="actions" id="actions">
            <button class="action-btn download-btn" id="downloadBtn" onclick="downloadCSV()">
                下載CSV檔案
            </button>
        </div>
    </div>

    <script>
        // 全局變數
        let workbook = null;
        let allData = [];
        let personList = new Set();
        let authPersonnel = new Set();
        let nonAuthPersonnel = new Set();
        let totalFlights = 0;
        let flightChart = null;
        let selectedPerson = '';
        let personFlightsData = {};
        let processedSheets = [];
        let debugLog = [];
        
        // 完整的中文姓氏列表
        const chineseSurnames = [
            '趙', '錢', '孫', '李', '周', '吳', '鄭', '王', '馮', '陳', '褚', '衛', '蔣', '沈', '韓', '楊',
            '朱', '秦', '尤', '許', '何', '呂', '施', '張', '孔', '曹', '嚴', '華', '金', '魏', '陶', '姜',
            '戚', '謝', '鄒', '喻', '柏', '水', '竇', '章', '雲', '蘇', '潘', '葛', '奚', '范', '彭', '郎',
            '魯', '韋', '昌', '馬', '苗', '鳳', '花', '方', '俞', '任', '袁', '柳', '酆', '鮑', '史', '唐',
            '費', '廉', '岑', '薛', '雷', '賀', '倪', '湯', '滕', '殷', '羅', '畢', '郝', '鄔', '安', '常',
            '樂', '於', '時', '傅', '皮', '卞', '齊', '康', '伍', '余', '元', '卜', '顧', '孟', '平', '黃',
            '和', '穆', '蕭', '尹', '姚', '邵', '湛', '汪', '祁', '毛', '禹', '狄', '米', '貝', '明', '臧',
            '計', '伏', '成', '戴', '談', '宋', '茅', '龐', '熊', '紀', '舒', '屈', '項', '祝', '董', '梁',
            '杜', '阮', '藍', '閔', '席', '季', '麻', '強', '賈', '路', '婁', '危', '江', '童', '顏', '郭',
            '梅', '盛', '林', '刁', '鍾', '徐', '邱', '駱', '高', '夏', '蔡', '田', '樊', '胡', '凌', '霍',
            '虞', '萬', '支', '柯', '昝', '管', '盧', '莫', '經', '房', '裘', '繆', '干', '解', '應', '宗',
            '丁', '宣', '賁', '鄧', '郁', '單', '杭', '洪', '包', '諸', '左', '石', '崔', '吉', '鈕', '龔',
            '程', '嵇', '邢', '滑', '裴', '陸', '榮', '翁', '荀', '羊', '於', '惠', '甄', '麴', '家', '封',
            '芮', '羿', '儲', '靳', '汲', '邴', '糜', '松', '井', '段', '富', '巫', '烏', '焦', '巴', '弓',
            '牧', '隗', '山', '谷', '車', '侯', '宓', '蓬', '全', '郗', '班', '仰', '秋', '仲', '伊', '宮',
            '甯', '仇', '欒', '暴', '甘', '鈄', '厲', '戎', '祖', '武', '符', '劉', '景', '詹', '束', '龍',
            '葉', '幸', '司', '韶', '郜', '黎', '薊', '薄', '印', '宿', '白', '懷', '蒲', '邰', '從', '鄂',
            '索', '咸', '籍', '賴', '卓', '藺', '屠', '蒙', '池', '喬', '陰', '鬱', '胥', '能', '蒼', '雙',
            '聞', '莘', '黨', '翟', '譚', '貢', '勞', '逄', '姬', '申', '扶', '堵', '冉', '宰', '酈', '雍',
            '郤', '璩', '桑', '桂', '濮', '牛', '壽', '通', '邊', '扈', '燕', '冀', '郟', '浦', '尚', '農',
            '溫', '別', '莊', '晏', '柴', '瞿', '閻', '充', '慕', '連', '茹', '習', '宦', '艾', '魚', '容',
            '向', '古', '易', '慎', '戈', '廖', '庾', '終', '暨', '居', '衡', '步', '都', '耿', '滿', '弘',
            '匡', '國', '文', '寇', '廣', '祿', '闕', '東', '歐', '殳', '沃', '利', '蔚', '越', '夔', '隆',
            '師', '鞏', '厙', '聶', '晁', '勾', '敖', '融', '冷', '訾', '辛', '闞', '那', '簡', '饒', '空',
            '曾', '毋', '沙', '乜', '養', '鞠', '須', '豐', '巢', '關', '蒯', '相', '查', '後', '荊', '紅',
            '游', '竺', '權', '逯', '蓋', '益', '桓', '公', '萬俟', '司馬', '上官', '歐陽', '夏侯', '諸葛',
            '聞人', '東方', '赫連', '皇甫', '尉遲', '公羊', '澹台', '公冶', '宗政', '濮陽', '淳于', '單于',
            '太叔', '申屠', '公孫', '仲孫', '軒轅', '令狐', '鍾離', '宇文', '長孫', '慕容', '鮮于', '閭丘',
            '司徒', '司空', '亓官', '司寇', '仉', '督', '子車', '顓孫', '端木', '巫馬', '公西', '漆雕', '樂正',
            '壤駟', '公良', '拓跋', '夾谷', '宰父', '穀梁', '晉', '楚', '閆', '法', '汝', '鄢', '塗', '欽',
            '段干', '百里', '東郭', '南門', '呼延', '歸', '海', '羊舌', '微生', '岳', '帥', '緱', '亢', '況',
            '後', '有', '琴', '梁丘', '左丘', '東門', '西門', '商', '牟', '佘', '佴', '伯', '賞', '南宮',
            '墨', '哈', '譙', '笪', '年', '愛', '陽', '佟', '第五', '言', '福'
        ];
        
        // 非人名詞彙列表（擴展版本，包含車輛相關詞彙）
        const nonPersonWords = [
            '關電', '先接', '早到先', '早到先接', '發證室', '帶除蟲', '送車', '用車', '待命', '備勤',
            '悉放', '早到', '一人服', '輸入', '台飛', '注意', '早全', '值勤', '聽耳', '推耳', '開加', '開放',
            '送', '油', '不加', '拖機', '簽', '接機', '簽放人員', '協助人員', '接機人員', '代領班', '領班',
            '組長', '值勤組長', '代組長', 'QC', '庫房', '外派', '隨機', '公差', '公出', '公假', '調度',
            '加班', '值班', '請假', '休假', '病假', '事假', 'NIL', 'nil', 'Nil',
            '早班', '晚班', '大夜班', '小夜班', '值班室', '待命室', '機坪', '機庫',
            '早', '到', '先', '全', '電', '車', '油', '機', '班', '組', '長', '房', '室',
            '早先', '先到', '早全接', '早全到', '早全先',
            // 新增的工作備註詞彙組合
            '加油', '上車', '拖機', '修機', '補油', '調機', '換班', '整備', '檢修', '測試', '驗收', '檢查',
            '放行', '開機', '關機', '推機', '拉機', '移機', '搬運', '裝機', '卸機', '拆機', '組裝',
            '領班', '代班', '替班', '幫忙', '協助', '輔助', '教導', '學習', '練習',
            '待命', '等候', '等待', '備勤', '值勤', '輪班', '排班', '調度', '休假',
            '急件', '快速', '慢速', '延誤', '遲到', '早到', '晚到', '夜班', '日班', '午班', '晨班',
            '大修', '小修', '長班', '短班', '高空', '低空', '多機', '少機', '重機', '輕機',
            '新機', '舊機', '好機', '壞機', '優良', '良好', '差機', '劣機', '完成', '未完成',
            '已到', '將到', '正在', '完畢', '結束', '開始',
            // 新增車輛相關詞彙
            '車輛', '车', '辆', '车子', '车辆调度', '用车', '送车', '接车', '用车送', '用車送',
            '用車', '用車接', '車輛接', '車輛送', '車輛調度', '車調度', '車子', '车辆使用',
            '車輛使用', '車輛安排', '車安排', '車輛調配', '車調配'
        ];
        
        // 特殊過濾詞彙
        const specialFilterWords = ['早到先', '早到', '先接', '早全', '早先', '先到', '早全接', '早全到', '早全先'];
        
        // 處理檔案選擇
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = `已選擇檔案: ${file.name}`;
            showStatus('檔案已選擇，正在分析中...', 'info');
            
            resetAnalysis();
            showLoading(true);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, {type: 'array'});
                    analyzeWorkbook(workbook);
                    showLoading(false);
                } catch (error) {
                    console.error('分析檔案時發生錯誤:', error);
                    showStatus('分析檔案時發生錯誤: ' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onerror = function() {
                showStatus('讀取檔案時發生錯誤', 'error');
                showLoading(false);
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 重置分析狀態
        function resetAnalysis() {
            workbook = null;
            allData = [];
            personList.clear();
            authPersonnel.clear();
            nonAuthPersonnel.clear();
            totalFlights = 0;
            selectedPerson = '';
            personFlightsData = {};
            processedSheets = [];
            debugLog = [];
            
            if (flightChart) {
                flightChart.destroy();
                flightChart = null;
            }
            
            document.getElementById('personSelector').style.display = 'none';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('personDetails').style.display = 'none';
            document.getElementById('monthTotal').style.display = 'none';
            document.getElementById('actions').style.display = 'none';
            
            document.getElementById('personSelect').innerHTML = '<option value="">請選擇人員</option>';
            document.getElementById('personNameDisplay').textContent = '';
            document.getElementById('personTotalFlights').textContent = '';
            document.getElementById('authDetails').innerHTML = '';
            document.getElementById('nonAuthDetails').innerHTML = '';
        }
        
        // 分析工作簿
        function analyzeWorkbook(workbook) {
            allData = [];
            personList.clear();
            authPersonnel.clear();
            nonAuthPersonnel.clear();
            totalFlights = 0;
            personFlightsData = {};
            processedSheets = [];
            debugLog = [];
            
            addDebugLog(`開始分析工作簿，共有 ${workbook.SheetNames.length} 個工作表`);
            
            workbook.SheetNames.forEach(sheetName => {
                if (sheetName.match(/^[0-9]{4}$/)) {
                    const worksheet = workbook.Sheets[sheetName];
                    addDebugLog(`處理工作表: ${sheetName}`);
                    processWorksheet(worksheet, sheetName);
                    processedSheets.push(sheetName);
                } else {
                    addDebugLog(`跳過非標準工作表名稱: ${sheetName}`);
                }
            });
            
            if (processedSheets.length === 0) {
                addDebugLog('未找到標準工作表名稱，嘗試處理所有工作表');
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    addDebugLog(`嘗試處理工作表: ${sheetName}`);
                    processWorksheet(worksheet, sheetName);
                    processedSheets.push(sheetName);
                });
            }
            
            // 處理完所有工作表後，進行姓名合併
            if (allData.length > 0) {
                mergeSimilarNames();
            }
            
            updateUI();
            showStatus(`分析完成！共處理 ${allData.length} 筆航班資料，來自 ${processedSheets.length} 個工作表`, 'success');
            displayDebugLog();
        }
        
        // 處理單個工作表
        function processWorksheet(worksheet, sheetName) {
            try {
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (!jsonData || jsonData.length < 4) {
                    addDebugLog(`工作表 ${sheetName} 資料不足，跳過`);
                    return;
                }
                
                const date = extractDate(sheetName, jsonData);
                
                for (let i = 3; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (row && row[0] && typeof row[0] === 'string' && row[0].trim() && !row[0].includes('機號')) {
                        processFlightRow(row, date);
                        totalFlights++;
                    }
                }
                
            } catch (error) {
                console.error(`處理工作表 ${sheetName} 時發生錯誤:`, error);
                addDebugLog(`處理工作表 ${sheetName} 時發生錯誤: ${error.message}`);
            }
        }
        
        // 提取日期
        function extractDate(sheetName, jsonData) {
            if (sheetName.match(/^[0-9]{4}$/)) {
                const month = sheetName.substring(0, 2);
                const day = sheetName.substring(2, 4);
                return `${month}/${day}`;
            }
            
            try {
                if (jsonData && jsonData.length > 0) {
                    const firstRow = jsonData[0];
                    if (firstRow && firstRow.length > 0) {
                        const dateStr = String(firstRow[0]);
                        const dateMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})/);
                        if (dateMatch) {
                            const month = dateMatch[1].padStart(2, '0');
                            const day = dateMatch[2].padStart(2, '0');
                            return `${month}/${day}`;
                        }
                    }
                }
            } catch (e) {
                addDebugLog(`無法從工作表 ${sheetName} 提取日期: ${e.message}`);
            }
            
            return sheetName;
        }
        
        // 處理航班資料行
        function processFlightRow(row, date) {
            const safeRow = [...row];
            while (safeRow.length < 12) {
                safeRow.push('');
            }
            
            const flightData = {
                日期: date,
                機號: safeRow[0] || '',
                B_G: safeRow[1] || '',
                機型: safeRow[2] || '',
                檢查: safeRow[3] || '',
                入境: safeRow[4] || '',
                出境: safeRow[5] || '',
                STA: safeRow[6] || '',
                STD: safeRow[7] || '',
                來自: safeRow[8] || '',
                飛往: safeRow[9] || '',
                簽放人員: safeRow[10] || '',
                接機人員: safeRow[11] || ''
            };
            
            // 處理授權人員
            const authPersonnelStr = flightData.簽放人員 || '';
            if (authPersonnelStr) {
                const personnelList = extractPersonnel(authPersonnelStr);
                
                personnelList.forEach(person => {
                    if (person) {
                        personList.add(person);
                        authPersonnel.add(person);
                        
                        const record = {
                            ...flightData,
                            人員: person,
                            人員類型: '授權人員',
                            原始名稱: person
                        };
                        allData.push(record);
                        
                        updatePersonFlightsData(person, date, record, 'auth');
                    }
                });
            }
            
            // 處理非授權人員
            const nonAuthPersonnelStr = flightData.接機人員 || '';
            if (nonAuthPersonnelStr) {
                const personnelList = extractPersonnel(nonAuthPersonnelStr);
                
                personnelList.forEach(person => {
                    if (person) {
                        personList.add(person);
                        nonAuthPersonnel.add(person);
                        
                        const record = {
                            ...flightData,
                            人員: person,
                            人員類型: '非授權人員',
                            原始名稱: person
                        };
                        allData.push(record);
                        
                        updatePersonFlightsData(person, date, record, 'nonAuth');
                    }
                });
            }
        }
        
        // 從字串中提取人員名單 - 改進的智能分割策略
        function extractPersonnel(personnelStr) {
            if (!personnelStr || typeof personnelStr !== 'string') {
                return [];
            }
            
            let cleanedStr = personnelStr.toString().trim();
            addDebugLog(`原始人員字串: "${personnelStr}"`);
            
            if (!cleanedStr) {
                return [];
            }
            
            // 1. 檢查是否為特殊過濾詞彙
            for (const word of specialFilterWords) {
                if (cleanedStr === word) {
                    addDebugLog(`跳過特殊過濾詞彙: "${cleanedStr}"`);
                    return [];
                }
            }
            
            // 2. 檢查是否為非人名詞彙
            for (const word of nonPersonWords) {
                if (cleanedStr === word) {
                    addDebugLog(`跳過非人名詞彙: "${cleanedStr}"`);
                    return [];
                }
            }
            
            // 3. 移除所有數字和英文字母
            cleanedStr = cleanedStr.replace(/[0-9A-Za-z]/g, '');
            
            // 4. 移除特殊符號（保留斜線等分隔符）
            cleanedStr = cleanedStr.replace(/[()\[\]{}【】《》「」]/g, '');
            
            // 5. 移除時間格式
            cleanedStr = cleanedStr.replace(/\d{1,2}:\d{2}/g, '');
            
            // 6. 智能分割策略：識別完整姓名
            const names = smartSplitNames(cleanedStr);
            
            addDebugLog(`智能分割後名稱: ${names.join(', ')}`);
            
            // 7. 清理每個名字的尾隨詞彙（特別注意：不要移除"正"字，但移除"不"、"帶"、"耳"和"車輛"相關字）
            const cleanedNames = names.map(name => cleanNameTrailingWords(name));
            
            // 8. 過濾無效人名和空字符串
            const finalNames = [];
            
            for (const name of cleanedNames) {
                // 確保不是空字符串
                if (!name || name.trim().length === 0) {
                    addDebugLog(`跳過空名稱`);
                    continue;
                }
                
                if (isValidChineseName(name)) {
                    finalNames.push(name);
                } else {
                    addDebugLog(`跳過無效人名: "${name}"`);
                }
            }
            
            addDebugLog(`處理後名稱: ${finalNames.join(', ')}`);
            
            // 9. 移除重複的名字
            const uniqueNames = [...new Set(finalNames)];
            
            addDebugLog(`最終有效人名: ${uniqueNames.join(', ')}`);
            return uniqueNames;
        }
        
        // 清理姓名尾隨詞彙（改進版本，特別處理"車輛"等非人名詞彙）
        function cleanNameTrailingWords(name) {
            if (!name || name.length < 2) return name;
            
            // 首先檢查整個名稱是否為非人名詞彙
            for (const word of nonPersonWords) {
                if (name === word) {
                    return ''; // 返回空字串，表示不是人名
                }
            }
            
            // 檢查是否包含特定詞彙，如"車輛"
            if (name.includes('車輛') || name.includes('车') || name.includes('辆')) {
                return ''; // 返回空字串，表示不是人名
            }
            
            // 需要移除的尾隨詞彙（包括工作備註詞彙）
            // 注意："正"字在人名中應該保留（如"游源正"）
            // "不"字、"帶"字和"耳"字需要過濾
            const trailingWords = [
                '簽', '班', '先接', '早到', '先', '接', '早', '到', '車', '油', '機', '電', '送',
                '加', '上', '拖', '修', '補', '調', '換', '整', '檢', '測', '試', '驗', '查',
                '放', '開', '關', '推', '拉', '移', '搬', '運', '裝', '卸', '拆', '組',
                '領', '代', '替', '幫', '協', '助', '輔', '導', '教', '學', '練',
                '待', '候', '等', '備', '勤', '值', '輪', '排', '調', '休', '假',
                '急', '快', '慢', '延', '遲', '早', '晚', '夜', '日', '午', '晨',
                '大', '小', '長', '短', '高', '低', '多', '少', '重', '輕',
                '新', '舊', '好', '壞', '優', '良', '差', '劣', '完', '未',
                '已', '將', '在', '完', '畢', '結', '束', '開', '始',
                '不', '帶', '耳',  // 新增：過濾"不"字、"帶"字和"耳"字
                '輛', '辆'  // 新增：過濾"輛"字
            ];
            
            let cleaned = name;
            let continueCleaning = true;
            
            while (continueCleaning && cleaned.length >= 2) {
                continueCleaning = false;
                for (const word of trailingWords) {
                    if (cleaned.endsWith(word)) {
                        cleaned = cleaned.slice(0, -word.length);
                        addDebugLog(`移除尾隨詞彙 "${word}"，得到: "${cleaned}"`);
                        continueCleaning = true;
                        break;
                    }
                }
            }
            
            // 如果清理後變得太短（小於2個字），返回空字串
            if (cleaned.length < 2) {
                return '';
            }
            
            return cleaned;
        }
        
        // 智能分割姓名的函數
        function smartSplitNames(str) {
            if (!str) return [];
            
            // 先移除所有空白字符
            str = str.replace(/\s+/g, '');
            
            // 常見的分隔符列表，按優先級排列
            const separators = [
                '//', '／', '/',  // 斜線分隔符
                '、',             // 中文頓號
                '，', ',',       // 逗號
                '　',            // 全形空格
                '+', '＋',       // 加號
            ];
            
            let names = [];
            let currentStr = str;
            
            // 優先處理明顯的分隔符
            for (const sep of separators) {
                if (currentStr.includes(sep)) {
                    const parts = currentStr.split(sep)
                        .map(part => part.trim())
                        .filter(part => part && part.length > 0);
                    
                    if (parts.length > 1) {
                        // 對每個部分遞歸處理
                        parts.forEach(part => {
                            names = names.concat(smartSplitNames(part));
                        });
                        return names;
                    }
                }
            }
            
            // 特別處理"和"字 - 謹慎處理
            if (currentStr.includes('和')) {
                // 檢查是否為可能的人名（如"余謙和"）
                const length = currentStr.length;
                
                // 如果是2-4字的姓名，且包含"和"，很可能是一個完整姓名
                if (length >= 2 && length <= 4) {
                    // 檢查是否為有效中文人名
                    const chineseRegex = /^[\u4e00-\u9fa5]+$/;
                    if (chineseRegex.test(currentStr)) {
                        // 檢查第一個字是否為姓氏
                        const firstChar = currentStr.charAt(0);
                        if (chineseSurnames.includes(firstChar)) {
                            return [currentStr]; // 返回完整姓名
                        }
                        
                        // 檢查前兩個字是否為複姓
                        if (length >= 3) {
                            const firstTwoChars = currentStr.substring(0, 2);
                            if (chineseSurnames.includes(firstTwoChars)) {
                                return [currentStr]; // 返回完整姓名
                            }
                        }
                    }
                }
                
                // 如果長度超過4個字，嘗試用"和"分割，但保留包含"和"的完整姓名
                const parts = currentStr.split('和');
                if (parts.length > 1) {
                    // 對於每個部分，檢查是否是有效人名
                    const validParts = [];
                    parts.forEach((part, index) => {
                        if (part && part.length > 0) {
                            // 如果是第一個部分，且後面還有部分，檢查是否可能是不完整姓名
                            if (index === 0 && parts.length > 1 && parts[1].length > 0) {
                                // 檢查part + "和" + 下一個部分是否可能是完整姓名
                                const possibleFullName = part + '和' + parts[1];
                                if (isValidChineseName(possibleFullName)) {
                                    // 跳過，讓後續處理
                                    return;
                                }
                            }
                            
                            // 遞歸處理每個部分
                            const subNames = smartSplitNames(part);
                            validParts.push(...subNames);
                        }
                    });
                    
                    if (validParts.length > 0) {
                        return validParts;
                    }
                }
            }
            
            // 處理"及"字
            if (currentStr.includes('及')) {
                const parts = currentStr.split('及')
                    .map(part => part.trim())
                    .filter(part => part && part.length > 0);
                
                if (parts.length > 1) {
                    parts.forEach(part => {
                        names = names.concat(smartSplitNames(part));
                    });
                    return names;
                }
            }
            
            // 如果沒有找到任何分隔符，返回原始字符串
            return currentStr ? [currentStr] : [];
        }
        
        // 檢查是否為有效中文人名（改進版本，過濾"車輛"等詞彙）
        function isValidChineseName(name) {
            if (!name) return false;
            
            // 檢查長度：2-4個字（考慮複姓）
            if (name.length < 2 || name.length > 4) {
                return false;
            }
            
            // 檢查是否全部為中文字符
            const chineseRegex = /^[\u4e00-\u9fa5]+$/;
            if (!chineseRegex.test(name)) {
                return false;
            }
            
            // 檢查是否為非人名詞彙
            for (const word of nonPersonWords) {
                if (name === word) {
                    return false;
                }
            }
            
            // 特別檢查是否包含非人名詞彙（如"車輛"等）
            const invalidPatterns = ['車', '辆', '機', '班', '簽', '油', '電', '送', '加', '上', '拖', '修'];
            for (const pattern of invalidPatterns) {
                if (name.includes(pattern) && name.length <= 3) {
                    // 如果名稱包含這些字且長度很短，很可能不是人名
                    // 但如果是最後一個字是"車"，且長度為2，可能是真實姓氏"車"
                    if (pattern === '車' && name.length === 2 && chineseSurnames.includes(name.charAt(0))) {
                        continue; // 可能是真實姓名，繼續檢查
                    }
                    return false;
                }
            }
            
            // 檢查是否為姓氏（考慮複姓）
            // 先檢查前兩個字符是否為複姓
            const firstTwoChars = name.substring(0, 2);
            if (chineseSurnames.includes(firstTwoChars)) {
                return true;
            }
            
            // 檢查第一個字符是否為單姓
            const firstChar = name.charAt(0);
            if (chineseSurnames.includes(firstChar)) {
                return true;
            }
            
            return false;
        }
        
        // 合併相似姓名
        function mergeSimilarNames() {
            // 找出所有可能的姓名變體
            const nameVariants = {};
            
            // 收集所有姓名
            const allNames = Array.from(personList);
            
            // 找出相似的姓名（前綴匹配）
            allNames.forEach(name1 => {
                allNames.forEach(name2 => {
                    if (name1 !== name2) {
                        // 檢查一個是否是另一個的前綴
                        if (name2.startsWith(name1) && name2.length > name1.length) {
                            if (!nameVariants[name1]) {
                                nameVariants[name1] = new Set();
                            }
                            nameVariants[name1].add(name2);
                        } else if (name1.startsWith(name2) && name1.length > name2.length) {
                            if (!nameVariants[name2]) {
                                nameVariants[name2] = new Set();
                            }
                            nameVariants[name2].add(name1);
                        }
                    }
                });
            });
            
            // 合併資料：將較短姓名的資料合併到較長姓名中
            Object.keys(nameVariants).forEach(shortName => {
                const longNames = Array.from(nameVariants[shortName]);
                
                longNames.forEach(longName => {
                    addDebugLog(`合併姓名變體: ${shortName} -> ${longName}`);
                    
                    // 合併 personFlightsData
                    if (personFlightsData[shortName] && personFlightsData[longName]) {
                        // 合併授權航班
                        for (const date in personFlightsData[shortName].authFlights) {
                            if (!personFlightsData[longName].authFlights[date]) {
                                personFlightsData[longName].authFlights[date] = [];
                            }
                            personFlightsData[longName].authFlights[date].push(...personFlightsData[shortName].authFlights[date]);
                            personFlightsData[longName].authCount += personFlightsData[shortName].authFlights[date].length;
                        }
                        
                        // 合並非授權航班
                        for (const date in personFlightsData[shortName].nonAuthFlights) {
                            if (!personFlightsData[longName].nonAuthFlights[date]) {
                                personFlightsData[longName].nonAuthFlights[date] = [];
                            }
                            personFlightsData[longName].nonAuthFlights[date].push(...personFlightsData[shortName].nonAuthFlights[date]);
                            personFlightsData[longName].nonAuthCount += personFlightsData[shortName].nonAuthFlights[date].length;
                        }
                        
                        // 更新總數
                        personFlightsData[longName].totalFlights = 
                            personFlightsData[longName].authCount + personFlightsData[longName].nonAuthCount;
                        
                        // 從資料結構中移除短姓名
                        delete personFlightsData[shortName];
                        personList.delete(shortName);
                        
                        // 更新授權/非授權人員列表
                        if (authPersonnel.has(shortName)) {
                            authPersonnel.delete(shortName);
                            authPersonnel.add(longName);
                        }
                        if (nonAuthPersonnel.has(shortName)) {
                            nonAuthPersonnel.delete(shortName);
                            nonAuthPersonnel.add(longName);
                        }
                        
                        // 更新所有資料中的姓名
                        allData.forEach(record => {
                            if (record.人員 === shortName) {
                                record.人員 = longName;
                            }
                        });
                        
                        addDebugLog(`已將 ${shortName} 的資料合併到 ${longName}`);
                    }
                });
            });
            
            // 特別處理"余謙"和"余謙和"的情況
            if (personList.has('余謙') && personList.has('余謙和')) {
                addDebugLog(`特別合併: 余謙 -> 余謙和`);
                
                // 合併 personFlightsData
                if (personFlightsData['余謙'] && personFlightsData['余謙和']) {
                    // 合併授權航班
                    for (const date in personFlightsData['余謙'].authFlights) {
                        if (!personFlightsData['余謙和'].authFlights[date]) {
                            personFlightsData['余謙和'].authFlights[date] = [];
                        }
                        personFlightsData['余謙和'].authFlights[date].push(...personFlightsData['余謙'].authFlights[date]);
                        personFlightsData['余謙和'].authCount += personFlightsData['余謙'].authFlights[date].length;
                    }
                    
                    // 合並非授權航班
                    for (const date in personFlightsData['余謙'].nonAuthFlights) {
                        if (!personFlightsData['余謙和'].nonAuthFlights[date]) {
                            personFlightsData['余謙和'].nonAuthFlights[date] = [];
                        }
                        personFlightsData['余謙和'].nonAuthFlights[date].push(...personFlightsData['余謙'].nonAuthFlights[date]);
                        personFlightsData['余謙和'].nonAuthCount += personFlightsData['余謙'].nonAuthFlights[date].length;
                    }
                    
                    // 更新總數
                    personFlightsData['余謙和'].totalFlights = 
                        personFlightsData['余謙和'].authCount + personFlightsData['余謙和'].nonAuthCount;
                    
                    // 從資料結構中移除"余謙"
                    delete personFlightsData['余謙'];
                    personList.delete('余謙');
                    
                    // 更新授權/非授權人員列表
                    if (authPersonnel.has('余謙')) {
                        authPersonnel.delete('余謙');
                        authPersonnel.add('余謙和');
                    }
                    if (nonAuthPersonnel.has('余謙')) {
                        nonAuthPersonnel.delete('余謙');
                        nonAuthPersonnel.add('余謙和');
                    }
                    
                    // 更新所有資料中的姓名
                    allData.forEach(record => {
                        if (record.人員 === '余謙') {
                            record.人員 = '余謙和';
                        }
                    });
                    
                    addDebugLog(`已將 余謙 的資料合併到 余謙和`);
                }
            }
            
            // 顯示合併結果
            if (Object.keys(nameVariants).length > 0) {
                addDebugLog(`姓名合併完成，共處理 ${Object.keys(nameVariants).length} 個姓名變體`);
            }
        }
        
        // 更新人員航班數據
        function updatePersonFlightsData(person, date, flightRecord, type) {
            if (!personFlightsData[person]) {
                personFlightsData[person] = {
                    authFlights: {},
                    nonAuthFlights: {},
                    totalFlights: 0,
                    authCount: 0,
                    nonAuthCount: 0
                };
            }
            
            if (type === 'auth') {
                if (!personFlightsData[person].authFlights[date]) {
                    personFlightsData[person].authFlights[date] = [];
                }
                personFlightsData[person].authFlights[date].push(flightRecord);
                personFlightsData[person].authCount++;
            } else {
                if (!personFlightsData[person].nonAuthFlights[date]) {
                    personFlightsData[person].nonAuthFlights[date] = [];
                }
                personFlightsData[person].nonAuthFlights[date].push(flightRecord);
                personFlightsData[person].nonAuthCount++;
            }
            
            personFlightsData[person].totalFlights++;
        }
        
        // 更新UI
        function updateUI() {
            updateSummary();
            updatePersonSelect();
            updateMonthTotal();
            
            document.getElementById('summary').style.display = 'grid';
            document.getElementById('personSelector').style.display = 'block';
            document.getElementById('monthTotal').style.display = 'block';
            document.getElementById('actions').style.display = 'flex';
            
            if (personList.size === 1) {
                const firstPerson = Array.from(personList)[0];
                selectPerson(firstPerson);
            }
        }
        
        // 更新摘要
        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            
            let overlapCount = 0;
            authPersonnel.forEach(person => {
                if (nonAuthPersonnel.has(person)) {
                    overlapCount++;
                }
            });
            
            summaryDiv.innerHTML = `
                <div class="summary-item">
                    <h3>處理天數</h3>
                    <p>${new Set(allData.map(d => d.日期)).size}</p>
                </div>
                <div class="summary-item">
                    <h3>總人員數</h3>
                    <p>${personList.size}</p>
                </div>
                <div class="summary-item">
                    <h3>授權人員數</h3>
                    <p>${authPersonnel.size}</p>
                </div>
                <div class="summary-item">
                    <h3>非授權人員數</h3>
                    <p>${nonAuthPersonnel.size}</p>
                </div>
                <div class="summary-item">
                    <h3>總航班數</h3>
                    <p>${totalFlights}</p>
                </div>
            `;
            
            // 顯示人員名單
            const authNames = Array.from(authPersonnel).sort();
            const nonAuthNames = Array.from(nonAuthPersonnel).sort();
            
            const namesSection = document.createElement('div');
            namesSection.className = 'person-info';
            namesSection.style.marginTop = '20px';
            namesSection.style.padding = '20px';
            namesSection.style.backgroundColor = '#f8f9fa';
            namesSection.style.borderRadius = '8px';
            namesSection.style.display = 'block';
            
            namesSection.innerHTML = `
                <div style="flex: 1;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">授權人員名單 (${authNames.length})</h4>
                    <div class="name-list">
                        ${authNames.map(name => `<span class="name-tag auth">${name}</span>`).join('')}
                    </div>
                </div>
                <div style="flex: 1; margin-top: 20px;">
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">非授權人員名單 (${nonAuthNames.length})</h4>
                    <div class="name-list">
                        ${nonAuthNames.map(name => `<span class="name-tag non-auth">${name}</span>`).join('')}
                    </div>
                </div>
            `;
            
            summaryDiv.appendChild(namesSection);
            
            // 如果有姓名合併，顯示提示
            if (Object.keys(personFlightsData).some(name => name.includes('和'))) {
                const variantInfo = document.createElement('div');
                variantInfo.className = 'variant-names';
                variantInfo.innerHTML = `
                    <p><span>注意：</span>系統已自動合併相似姓名變體（如"余謙"和"余謙和"已合併為"余謙和"）</p>
                `;
                summaryDiv.appendChild(variantInfo);
            }
        }
        
        // 更新人員選擇下拉選單
        function updatePersonSelect() {
            const personSelect = document.getElementById('personSelect');
            
            personSelect.innerHTML = '<option value="">請選擇人員</option>';
            
            // 對人員按姓名排序
            const sortedPersonnel = Array.from(personList)
                .filter(person => {
                    if (!person || !person.trim()) return false;
                    
                    // 確保是有效的人名
                    if (person.length < 2 || person.length > 4) return false;
                    
                    // 檢查第一個字是否為姓氏
                    const firstChar = person.charAt(0);
                    if (!chineseSurnames.includes(firstChar)) {
                        // 檢查前兩個字是否為複姓
                        const firstTwoChars = person.substring(0, 2);
                        if (!chineseSurnames.includes(firstTwoChars)) {
                            return false;
                        }
                    }
                    
                    return true;
                })
                .sort();
            
            sortedPersonnel.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                personSelect.appendChild(option);
            });
            
            addDebugLog(`下拉選單人員數量: ${sortedPersonnel.length}`);
        }
        
        // 更新當月總航班數
        function updateMonthTotal() {
            if (allData.length === 0) {
                document.getElementById('monthTotal').innerHTML = '當月總航班數: 0 個航班';
                return;
            }
            
            const months = new Set();
            allData.forEach(item => {
                const dateParts = item.日期.split('/');
                if (dateParts.length === 2) {
                    months.add(dateParts[0]);
                }
            });
            
            const monthList = Array.from(months).sort();
            const monthText = monthList.length === 1 ? 
                `${monthList[0]}月` : 
                `${monthList.join('月、')}月`;
            
            document.getElementById('monthTotal').innerHTML = `${monthText}總航班數: ${totalFlights} 個航班`;
        }
        
        // 選擇人員
        function selectPerson(personName) {
            if (!personName) {
                document.getElementById('chartContainer').style.display = 'none';
                document.getElementById('personDetails').style.display = 'none';
                return;
            }
            
            selectedPerson = personName;
            
            document.getElementById('personNameDisplay').textContent = personName;
            
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('personDetails').style.display = 'grid';
            
            updateChart(personName);
            updatePersonDetails(personName);
        }
        
        // 更新圖表
        function updateChart(personName) {
            const ctx = document.getElementById('flightChart').getContext('2d');
            
            if (flightChart) {
                flightChart.destroy();
            }
            
            const personData = personFlightsData[personName] || {
                authFlights: {},
                nonAuthFlights: {},
                totalFlights: 0,
                authCount: 0,
                nonAuthCount: 0
            };
            
            document.getElementById('personTotalFlights').textContent = personData.totalFlights;
            
            const allDates = Array.from(new Set([
                ...Object.keys(personData.authFlights),
                ...Object.keys(personData.nonAuthFlights)
            ])).sort((a, b) => {
                const [aMonth, aDay] = a.split('/').map(Number);
                const [bMonth, bDay] = b.split('/').map(Number);
                return (aMonth * 100 + aDay) - (bMonth * 100 + bDay);
            });
            
            const authCounts = allDates.map(date => 
                personData.authFlights[date] ? personData.authFlights[date].length : 0
            );
            
            const nonAuthCounts = allDates.map(date => 
                personData.nonAuthFlights[date] ? personData.nonAuthFlights[date].length : 0
            );
            
            flightChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: '授權航班',
                            data: authCounts,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '非授權航班',
                            data: nonAuthCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '航班數'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + ' 個航班';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新人員詳細資料
        function updatePersonDetails(personName) {
            const personData = personFlightsData[personName] || {
                authFlights: {},
                nonAuthFlights: {},
                totalFlights: 0,
                authCount: 0,
                nonAuthCount: 0
            };
            
            const authDetails = document.getElementById('authDetails');
            const nonAuthDetails = document.getElementById('nonAuthDetails');
            
            if (personData.authCount > 0) {
                let authHTML = `
                    <div class="person-info">
                        <div class="person-info-item">
                            <div class="person-info-label">授權航班數</div>
                            <div class="person-info-value auth">${personData.authCount}</div>
                        </div>
                        <div class="person-info-item">
                            <div class="person-info-label">涉及天數</div>
                            <div class="person-info-value">${Object.keys(personData.authFlights).length}</div>
                        </div>
                    </div>
                `;
                
                const authDates = Object.keys(personData.authFlights).sort((a, b) => {
                    const [aMonth, aDay] = a.split('/').map(Number);
                    const [bMonth, bDay] = b.split('/').map(Number);
                    return (aMonth * 100 + aDay) - (bMonth * 100 + bDay);
                });
                
                authDates.forEach(date => {
                    const flights = personData.authFlights[date];
                    authHTML += `
                        <div class="flight-item">
                            <div class="flight-date">
                                ${date} <span class="flight-count">${flights.length}</span>
                            </div>
                            ${flights.map(flight => `
                                <div class="flight-info">
                                    ${flight.機號} | ${flight.機型} | ${flight.檢查} | 
                                    ${flight.入境 ? '入境:' + flight.入境 : ''}${flight.出境 ? ' 出境:' + flight.出境 : ''} | 
                                    ${flight.來自 ? '來自:' + flight.來自 : ''}${flight.飛往 ? ' 飛往:' + flight.飛往 : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                
                authDetails.innerHTML = authHTML;
            } else {
                authDetails.innerHTML = '<div class="no-data">無授權航班資料</div>';
            }
            
            if (personData.nonAuthCount > 0) {
                let nonAuthHTML = `
                    <div class="person-info">
                        <div class="person-info-item">
                            <div class="person-info-label">非授權航班數</div>
                            <div class="person-info-value non-auth">${personData.nonAuthCount}</div>
                        </div>
                        <div class="person-info-item">
                            <div class="person-info-label">涉及天數</div>
                            <div class="person-info-value">${Object.keys(personData.nonAuthFlights).length}</div>
                        </div>
                    </div>
                `;
                
                const nonAuthDates = Object.keys(personData.nonAuthFlights).sort((a, b) => {
                    const [aMonth, aDay] = a.split('/').map(Number);
                    const [bMonth, bDay] = b.split('/').map(Number);
                    return (aMonth * 100 + aDay) - (bMonth * 100 + bDay);
                });
                
                nonAuthDates.forEach(date => {
                    const flights = personData.nonAuthFlights[date];
                    nonAuthHTML += `
                        <div class="flight-item">
                            <div class="flight-date">
                                ${date} <span class="flight-count">${flights.length}</span>
                            </div>
                            ${flights.map(flight => `
                                <div class="flight-info">
                                    ${flight.機號} | ${flight.機型} | ${flight.檢查} | 
                                    ${flight.入境 ? '入境:' + flight.入境 : ''}${flight.出境 ? ' 出境:' + flight.出境 : ''} | 
                                    ${flight.來自 ? '來自:' + flight.來自 : ''}${flight.飛往 ? ' 飛往:' + flight.飛往 : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                
                nonAuthDetails.innerHTML = nonAuthHTML;
            } else {
                nonAuthDetails.innerHTML = '<div class="no-data">無非授權航班資料</div>';
            }
        }
        
        // 下載CSV檔案
        function downloadCSV() {
            if (allData.length === 0) {
                showStatus('沒有資料可下載', 'error');
                return;
            }
            
            let csvContent = "日期,人員,人員類型,機號,B/G,機型,檢查,入境,出境,STA,STD,來自,飛往\n";
            
            const sortedData = [...allData].sort((a, b) => {
                const [aMonth, aDay] = a.日期.split('/').map(Number);
                const [bMonth, bDay] = b.日期.split('/').map(Number);
                const dateCompare = (aMonth * 100 + aDay) - (bMonth * 100 + bDay);
                
                if (dateCompare !== 0) return dateCompare;
                
                const typeCompare = b.人員類型.localeCompare(a.人員類型);
                if (typeCompare !== 0) return typeCompare;
                
                return a.人員.localeCompare(b.人員);
            });
            
            sortedData.forEach(item => {
                const row = [
                    `"${item.日期 || ''}"`,
                    `"${item.人員 || ''}"`,
                    `"${item.人員類型 || ''}"`,
                    `"${item.機號 || ''}"`,
                    `"${item.B_G || ''}"`,
                    `"${item.機型 || ''}"`,
                    `"${item.檢查 || ''}"`,
                    `"${item.入境 || ''}"`,
                    `"${item.出境 || ''}"`,
                    `"${item.STA || ''}"`,
                    `"${item.STD || ''}"`,
                    `"${item.來自 || ''}"`,
                    `"${item.飛往 || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const originalFileName = document.getElementById('fileInput').files[0]?.name || '航班資料';
            const fileName = originalFileName.replace(/\.[^/.]+$/, "") + '_航班分析.csv';
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`CSV檔案已準備下載: ${fileName}`, 'success');
        }
        
        // 顯示載入狀態
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // 顯示狀態訊息
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        // 添加除錯日誌
        function addDebugLog(message) {
            debugLog.push(`${new Date().toLocaleTimeString()}: ${message}`);
            if (debugLog.length > 100) {
                debugLog = debugLog.slice(-50);
            }
        }
        
        // 顯示除錯日誌
        function displayDebugLog() {
            const summaryDiv = document.getElementById('summary');
            if (!summaryDiv || debugLog.length === 0) return;
            
            const debugSection = document.createElement('div');
            debugSection.className = 'debug-info';
            debugSection.innerHTML = `
                <div class="debug-title">除錯日誌 (最近${debugLog.length}條)</div>
                ${debugLog.map(log => `<div class="debug-item">${log}</div>`).join('')}
            `;
            
            summaryDiv.appendChild(debugSection);
        }
        
        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        });
    </script>
</body>
    </html>
